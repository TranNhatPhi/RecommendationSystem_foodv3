<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Age-Based Recommendations Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .test-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 0 auto;
            max-width: 1200px;
        }

        .test-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .customer-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }

        .age-group-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .age-group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .result-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .recipe-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #28a745;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .nutrition-focus {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .stats-row {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .btn-test {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(232, 67, 147, 0.3);
        }

        .log-area {
            background: #2d3436;
            color: #00b894;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="test-container">
            <div class="test-header">
                <h1><i class="fas fa-birthday-cake me-3"></i>Test Age-Based Recommendations Enhanced</h1>
                <p class="mb-0">Ki·ªÉm tra h·ªá th·ªëng g·ª£i √Ω m√≥n ƒÉn theo ƒë·ªô tu·ªïi v·ªõi d·ªØ li·ªáu kh√°ch h√†ng th·ª±c t·∫ø</p>
            </div>

            <div class="row">
                <!-- Control Panel -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs me-2"></i>Control Panel</h5>
                        </div>
                        <div class="card-body">
                            <!-- Customer Selection -->
                            <div class="mb-3">
                                <label class="form-label"><strong>Ch·ªçn kh√°ch h√†ng:</strong></label>
                                <select class="form-select" id="customerSelect">
                                    <option value="CUS00001">CUS00001 - Kh√°ch h√†ng m·∫´u 1</option>
                                    <option value="CUS00002">CUS00002 - Kh√°ch h√†ng m·∫´u 2</option>
                                    <option value="CUS00005">CUS00005 - Kh√°ch h√†ng m·∫´u 5</option>
                                    <option value="CUS00010">CUS00010 - Kh√°ch h√†ng m·∫´u 10</option>
                                    <option value="CUS00025">CUS00025 - Kh√°ch h√†ng m·∫´u 25</option>
                                    <option value="CUS00050">CUS00050 - Kh√°ch h√†ng m·∫´u 50</option>
                                    <option value="CUS00100">CUS00100 - Kh√°ch h√†ng m·∫´u 100</option>
                                </select>
                            </div>

                            <!-- Age Groups -->
                            <div class="mb-3">
                                <label class="form-label"><strong>Ch·ªçn nh√≥m tu·ªïi ƒë·ªÉ test:</strong></label>
                                <div class="age-group-card" data-age="children">
                                    <i class="fas fa-child me-2"></i>
                                    <strong>Tr·∫ª em (3-12 tu·ªïi)</strong>
                                    <br><small>M√≥n ƒÉn d·ªÖ l√†m, b·ªï d∆∞·ª°ng, th√≠ch h·ª£p tr·∫ª em</small>
                                </div>
                                <div class="age-group-card" data-age="teenagers">
                                    <i class="fas fa-user-graduate me-2"></i>
                                    <strong>Thanh thi·∫øu ni√™n (13-19 tu·ªïi)</strong>
                                    <br><small>M√≥n ƒÉn nƒÉng l∆∞·ª£ng cao, h·∫•p d·∫´n</small>
                                </div>
                                <div class="age-group-card" data-age="adults">
                                    <i class="fas fa-user me-2"></i>
                                    <strong>Ng∆∞·ªùi l·ªõn (20-59 tu·ªïi)</strong>
                                    <br><small>M√≥n ƒÉn ƒëa d·∫°ng, c√¢n b·∫±ng dinh d∆∞·ª°ng</small>
                                </div>
                                <div class="age-group-card" data-age="elderly">
                                    <i class="fas fa-user-plus me-2"></i>
                                    <strong>Ng∆∞·ªùi cao tu·ªïi (60+ tu·ªïi)</strong>
                                    <br><small>M√≥n ƒÉn d·ªÖ ti√™u h√≥a, b·ªï d∆∞·ª°ng</small>
                                </div>
                            </div>

                            <!-- Test All Button -->
                            <button class="btn btn-test w-100 mb-3" onclick="testAllAgeGroups()">
                                <i class="fas fa-rocket me-2"></i>Test T·∫•t C·∫£ Nh√≥m Tu·ªïi
                            </button>

                            <!-- Customer Info -->
                            <div id="customerInfo" class="customer-card">
                                <h6><i class="fas fa-user me-2"></i>Th√¥ng tin kh√°ch h√†ng</h6>
                                <div id="customerDetails">Ch·ªçn kh√°ch h√†ng ƒë·ªÉ xem th√¥ng tin...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-bar me-2"></i>K·∫øt qu·∫£ Test</h5>
                        </div>
                        <div class="card-body">
                            <div id="testResults">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-utensils fa-3x mb-3"></i>
                                    <p>Ch·ªçn m·ªôt nh√≥m tu·ªïi ƒë·ªÉ b·∫Øt ƒë·∫ßu test...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Area -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-terminal me-2"></i>Test Log</h5>
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">
                                <i class="fas fa-trash me-1"></i>X√≥a Log
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="testLog" class="log-area">
                                [LOG] Test age-based recommendations - S·∫µn s√†ng ki·ªÉm tra...<br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCustomer = 'CUS00001';

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            log('‚úÖ Trang test ƒë√£ t·∫£i th√†nh c√¥ng', 'success');
            loadCustomerInfo();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Customer selection change
            document.getElementById('customerSelect').addEventListener('change', function () {
                currentCustomer = this.value;
                loadCustomerInfo();
                log(`üîÑ ƒê·ªïi kh√°ch h√†ng: ${currentCustomer}`, 'info');
            });

            // Age group cards click
            document.querySelectorAll('.age-group-card').forEach(card => {
                card.addEventListener('click', function () {
                    const ageGroup = this.dataset.age;
                    testAgeGroup(ageGroup);
                });
            });
        }

        async function loadCustomerInfo() {
            try {
                // Get customer info from main page API or simulate it
                const customerDetails = document.getElementById('customerDetails');
                customerDetails.innerHTML = `
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    ƒêang t·∫£i th√¥ng tin kh√°ch h√†ng...
                `;

                // Simulate customer info loading (you can replace with actual API call)
                setTimeout(() => {
                    customerDetails.innerHTML = `
                        <strong>ID:</strong> ${currentCustomer}<br>
                        <strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">ƒê√£ ch·ªçn</span><br>
                        <small class="text-muted">S·∫µn s√†ng ƒë·ªÉ test g·ª£i √Ω theo ƒë·ªô tu·ªïi</small>
                    `;
                }, 500);
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i th√¥ng tin kh√°ch h√†ng: ${error.message}`, 'error');
            }
        }

        async function testAgeGroup(ageGroup) {
            log(`üéØ B·∫Øt ƒë·∫ßu test nh√≥m tu·ªïi: ${getAgeGroupName(ageGroup)}`, 'info');

            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p>ƒêang test g·ª£i √Ω cho ${getAgeGroupName(ageGroup)}...</p>
                </div>
            `;

            try {
                const startTime = Date.now();
                const url = `/api/age_based_recommendations?user_id=${currentCustomer}&age_group=${ageGroup}`;

                log(`üì° API Call: ${url}`, 'info');

                const response = await fetch(url);
                const data = await response.json();
                const endTime = Date.now();

                log(`‚è±Ô∏è Th·ªùi gian ph·∫£n h·ªìi: ${endTime - startTime}ms`, 'info');

                if (response.ok) {
                    displayResults(data, ageGroup);
                    log(`‚úÖ Th√†nh c√¥ng! Nh·∫≠n ƒë∆∞·ª£c ${data.recommendations?.length || 0} g·ª£i √Ω`, 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                log(`‚ùå L·ªói test nh√≥m tu·ªïi ${ageGroup}: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>L·ªói!</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displayResults(data, ageGroup) {
            const resultsDiv = document.getElementById('testResults');

            let html = `
                <div class="result-card">
                    <h4><i class="fas fa-birthday-cake me-2"></i>${getAgeGroupName(ageGroup)}</h4>
                    <div class="nutrition-focus">
                        <h6><i class="fas fa-heart me-2"></i>Tr·ªçng t√¢m dinh d∆∞·ª°ng:</h6>
                        <p class="mb-0">${data.nutrition_focus || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                    </div>
                    
                    <div class="stats-row">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Kh√°ch h√†ng:</strong><br>
                                <span class="text-primary">${data.user_id}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Tu·ªïi th·ª±c t·∫ø:</strong><br>
                                <span class="text-success">${data.customer_age ? data.customer_age + ' tu·ªïi' : 'Kh√¥ng x√°c ƒë·ªãnh'}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>S·ªë g·ª£i √Ω:</strong><br>
                                <span class="text-info">${data.total_recommendations || 0} m√≥n</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Nh√≥m tu·ªïi:</strong><br>
                                <span class="text-warning">${getAgeGroupName(ageGroup)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-utensils me-2"></i>Danh s√°ch g·ª£i √Ω:</h6>
                    <div class="row">
            `;

            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach((rec, index) => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="recipe-item">
                                <h6>${rec.recipe_name}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small><strong>ƒê·ªô kh√≥:</strong> ${rec.difficulty}</small>
                                    <small><strong>ƒê√°nh gi√°:</strong> ‚≠ê ${rec.predicted_rating?.toFixed(1)}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <small><strong>B·ªØa:</strong> ${translateMealTime(rec.meal_time)}</small>
                                    ${rec.estimated_calories ? `<small><strong>Calo:</strong> ${rec.estimated_calories}</small>` : ''}
                                </div>
                                ${rec.estimated_price_vnd ? `<small><strong>Gi√°:</strong> ${formatPrice(rec.estimated_price_vnd)} VND</small>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Kh√¥ng t√¨m th·∫•y g·ª£i √Ω n√†o cho nh√≥m tu·ªïi n√†y.
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        async function testAllAgeGroups() {
            log('üöÄ B·∫Øt ƒë·∫ßu test t·∫•t c·∫£ nh√≥m tu·ªïi...', 'info');

            const ageGroups = ['children', 'teenagers', 'adults', 'elderly'];
            let results = {};

            for (const ageGroup of ageGroups) {
                try {
                    log(`üîÑ Test ${getAgeGroupName(ageGroup)}...`, 'info');

                    const url = `/api/age_based_recommendations?user_id=${currentCustomer}&age_group=${ageGroup}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (response.ok) {
                        results[ageGroup] = {
                            success: true,
                            count: data.recommendations?.length || 0,
                            nutrition_focus: data.nutrition_focus,
                            customer_age: data.customer_age
                        };
                        log(`‚úÖ ${getAgeGroupName(ageGroup)}: ${results[ageGroup].count} g·ª£i √Ω`, 'success');
                    } else {
                        results[ageGroup] = { success: false, error: data.error };
                        log(`‚ùå ${getAgeGroupName(ageGroup)}: ${data.error}`, 'error');
                    }
                } catch (error) {
                    results[ageGroup] = { success: false, error: error.message };
                    log(`‚ùå ${getAgeGroupName(ageGroup)}: ${error.message}`, 'error');
                }
            }

            displayAllResults(results);
            log('üéØ Ho√†n th√†nh test t·∫•t c·∫£ nh√≥m tu·ªïi', 'info');
        }

        function displayAllResults(results) {
            const resultsDiv = document.getElementById('testResults');

            let html = `
                <div class="result-card">
                    <h4><i class="fas fa-chart-bar me-2"></i>T·ªïng k·∫øt Test All Age Groups</h4>
                    <div class="row">
            `;

            Object.entries(results).forEach(([ageGroup, result]) => {
                const statusClass = result.success ? 'success' : 'danger';
                const icon = result.success ? 'check-circle' : 'times-circle';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-${statusClass}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-${icon} text-${statusClass} me-2"></i>
                                    ${getAgeGroupName(ageGroup)}
                                </h6>
                                ${result.success ? `
                                    <p class="card-text">
                                        <strong>G·ª£i √Ω:</strong> ${result.count} m√≥n<br>
                                        <strong>Tu·ªïi kh√°ch h√†ng:</strong> ${result.customer_age || 'N/A'}<br>
                                        <small class="text-muted">${result.nutrition_focus}</small>
                                    </p>
                                ` : `
                                    <p class="card-text text-danger">
                                        <strong>L·ªói:</strong> ${result.error}
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // Utility functions
        function getAgeGroupName(ageGroup) {
            const names = {
                'children': 'Tr·∫ª em (3-12)',
                'teenagers': 'Thanh thi·∫øu ni√™n (13-19)',
                'adults': 'Ng∆∞·ªùi l·ªõn (20-59)',
                'elderly': 'Ng∆∞·ªùi cao tu·ªïi (60+)'
            };
            return names[ageGroup] || ageGroup;
        }

        function translateMealTime(mealTime) {
            const translations = {
                'breakfast': 'S√°ng',
                'lunch': 'Tr∆∞a',
                'dinner': 'T·ªëi'
            };
            return translations[mealTime] || mealTime;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#00b894',
                error: '#e17055',
                info: '#74b9ff',
                warning: '#fdcb6e'
            };

            logDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '[LOG] Log ƒë√£ ƒë∆∞·ª£c x√≥a...<br>';
        }
    </script>
</body>

</html>
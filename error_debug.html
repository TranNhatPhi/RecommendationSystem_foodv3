<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Ki·ªÉm tra l·ªói ch·ª©c nƒÉng "T√¨m m√≥n ƒÉn ph√π h·ª£p"</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .debug-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 0 auto;
            max-width: 900px;
        }

        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .status-ok {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .test-section {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .live-demo {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem 0;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-bug me-2 text-danger"></i>
            Ki·ªÉm tra l·ªói "T√¨m m√≥n ƒÉn ph√π h·ª£p"
        </h1>

        <!-- Error Monitoring -->
        <div class="test-section">
            <h4><i class="fas fa-exclamation-triangle me-2"></i>Theo d√µi l·ªói JavaScript</h4>
            <div id="errorCount" class="mb-2">L·ªói: <span class="badge bg-success">0</span></div>
            <div class="error-log" id="errorLog">Ch∆∞a ph√°t hi·ªán l·ªói n√†o...</div>
            <button class="btn btn-outline-danger btn-sm" onclick="clearErrors()">X√≥a l·ªói</button>
        </div>

        <!-- Function Check -->
        <div class="test-section">
            <h4><i class="fas fa-code me-2"></i>Ki·ªÉm tra c√°c h√†m JavaScript</h4>
            <button class="btn btn-primary" onclick="checkAllFunctions()">
                <i class="fas fa-play me-2"></i>Ki·ªÉm tra t·∫•t c·∫£ h√†m
            </button>
            <div class="error-log" id="functionResults">Nh·∫•n "Ki·ªÉm tra t·∫•t c·∫£ h√†m" ƒë·ªÉ b·∫Øt ƒë·∫ßu...</div>
        </div>

        <!-- Live Demo Test -->
        <div class="live-demo">
            <h4><i class="fas fa-utensils me-2"></i>Test tr·ª±c ti·∫øp ch·ª©c nƒÉng</h4>
            <form id="testForm" class="mb-3">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="testUserId" class="form-label">Ch·ªçn kh√°ch h√†ng</label>
                        <select class="form-select" id="testUserId" required>
                            <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                            <option value="1">KH0001 - Kh√°ch h√†ng 1</option>
                            <option value="2">KH0002 - Kh√°ch h√†ng 2</option>
                            <option value="50">KH0050 - Kh√°ch h√†ng 50</option>
                            <option value="100">KH0100 - Kh√°ch h√†ng 100</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="testRecommendationType" class="form-label">Lo·∫°i g·ª£i √Ω</label>
                        <select class="form-select" id="testRecommendationType" required>
                            <option value="">-- Ch·ªçn lo·∫°i g·ª£i √Ω --</option>
                            <option value="upsell_combos">üç± Combo m√≥n ƒÉn</option>
                            <option value="upsell_sides">ü•ó M√≥n ph·ª•</option>
                            <option value="family_combos">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Combo gia ƒë√¨nh</option>
                            <option value="age_based">üéÇ Theo ƒë·ªô tu·ªïi</option>
                        </select>
                    </div>
                </div>

                <!-- Additional Options (hidden by default) -->
                <div class="additional-options">
                    <div class="mb-3 d-none" id="testItemIdOption">
                        <label for="testItemId" class="form-label">ID m√≥n ch√≠nh</label>
                        <input type="text" class="form-control" id="testItemId" value="54">
                    </div>
                    <div class="mb-3 d-none" id="testMainDishIdOption">
                        <label for="testMainDishId" class="form-label">ID m√≥n ch√≠nh</label>
                        <input type="text" class="form-control" id="testMainDishId" value="54">
                    </div>
                    <div class="mb-3 d-none" id="testFamilySizeOption">
                        <label for="testFamilySize" class="form-label">S·ªë ng∆∞·ªùi trong gia ƒë√¨nh</label>
                        <input type="number" class="form-control" id="testFamilySize" value="4" min="1" max="10">
                    </div>
                    <div class="mb-3 d-none" id="testAgeGroupOption">
                        <label for="testAgeGroup" class="form-label">Nh√≥m tu·ªïi</label>
                        <select class="form-select" id="testAgeGroup">
                            <option value="children">üë∂ Tr·∫ª em (3-12 tu·ªïi)</option>
                            <option value="teenagers">üßí Thanh thi·∫øu ni√™n (13-19 tu·ªïi)</option>
                            <option value="adults">üë® Ng∆∞·ªùi l·ªõn (20-59 tu·ªïi)</option>
                            <option value="elderly">üë¥ Ng∆∞·ªùi cao tu·ªïi (60+ tu·ªïi)</option>
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-search me-2"></i>
                        üß™ TEST: T√¨m m√≥n ƒÉn ph√π h·ª£p
                    </button>
                </div>
            </form>

            <div class="error-log" id="testResults">ƒêi·ªÅn form v√† nh·∫•n n√∫t ƒë·ªÉ test...</div>
        </div>

        <!-- API Test -->
        <div class="test-section">
            <h4><i class="fas fa-cloud me-2"></i>Ki·ªÉm tra API tr·ª±c ti·∫øp</h4>
            <div class="row">
                <div class="col-md-3">
                    <button class="btn btn-outline-info btn-sm w-100" onclick="testAPI('upsell_combos')">
                        Test Combo
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-success btn-sm w-100" onclick="testAPI('upsell_sides')">
                        Test M√≥n ph·ª•
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-warning btn-sm w-100" onclick="testAPI('family_combos')">
                        Test Gia ƒë√¨nh
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="testAPI('age_based')">
                        Test Theo tu·ªïi
                    </button>
                </div>
            </div>
            <div class="error-log" id="apiResults">Nh·∫•n m·ªôt n√∫t API ƒë·ªÉ test...</div>
        </div>
    </div>

    <!-- Load main script to test -->
    <script src="/static/script.js"></script>

    <script>
        let errorCount = 0;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;

        // Override console functions to capture errors
        console.error = function (...args) {
            originalConsoleError.apply(console, args);
            addError('Console Error: ' + args.join(' '));
        };

        console.warn = function (...args) {
            originalConsoleWarn.apply(console, args);
            addError('Console Warning: ' + args.join(' '));
        };

        // Capture JavaScript errors
        window.addEventListener('error', function (e) {
            const errorMsg = `${e.message} at ${e.filename}:${e.lineno}:${e.colno}`;
            addError('JavaScript Error: ' + errorMsg);
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', function (e) {
            addError('Unhandled Promise Rejection: ' + e.reason);
        });

        function addError(errorMsg) {
            errorCount++;
            const errorLog = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();

            errorLog.textContent += `[${timestamp}] ERROR: ${errorMsg}\n`;
            errorLog.scrollTop = errorLog.scrollHeight;

            document.getElementById('errorCount').innerHTML = `L·ªói: <span class="badge bg-danger">${errorCount}</span>`;
        }

        function clearErrors() {
            document.getElementById('errorLog').textContent = 'ƒê√£ x√≥a l·ªói...';
            errorCount = 0;
            document.getElementById('errorCount').innerHTML = `L·ªói: <span class="badge bg-success">${errorCount}</span>`;
        }

        function checkAllFunctions() {
            const results = document.getElementById('functionResults');
            results.textContent = '';

            const functionsToTest = [
                'showModernToast',
                'initModernCustomerSelection',
                'handleFormSubmission',
                'initEnhancedFormHandling',
                'showLoadingSkeleton',
                'showErrorMessage',
                'generateStars',
                'getDifficultyClass',
                'getMealTimeClass',
                'translateMealTime',
                'translateAgeGroup',
                'translateNutritionType',
                'truncateText',
                'scrollToCustomerSelection',
                'displayRecommendationResults'
            ];

            let passed = 0;
            let failed = 0;

            results.textContent += 'Ki·ªÉm tra c√°c h√†m JavaScript...\n';
            results.textContent += '='.repeat(50) + '\n';

            functionsToTest.forEach(funcName => {
                try {
                    if (typeof window[funcName] === 'function') {
                        results.textContent += `‚úÖ ${funcName}: T√åM TH·∫§Y\n`;
                        passed++;
                    } else if (typeof window[funcName] !== 'undefined') {
                        results.textContent += `‚ö†Ô∏è ${funcName}: T·ªíN T·∫†I NH∆ØNG KH√îNG PH·∫¢I H√ÄM (${typeof window[funcName]})\n`;
                        failed++;
                    } else {
                        results.textContent += `‚ùå ${funcName}: THI·∫æU\n`;
                        failed++;
                    }
                } catch (e) {
                    results.textContent += `üî• ${funcName}: L·ªñI - ${e.message}\n`;
                    failed++;
                }
            });

            results.textContent += '='.repeat(50) + '\n';
            results.textContent += `T·ªïng k·∫øt: ${passed} OK, ${failed} L·ªñI\n`;

            if (failed === 0) {
                results.textContent += `üéâ T·∫§T C·∫¢ H√ÄM ƒê·ªÄU HO·∫†T ƒê·ªòNG B√åNH TH∆Ø·ªúNG!\n`;
            } else {
                results.textContent += `‚ö†Ô∏è C√ì ${failed} H√ÄM B·ªä L·ªñI HO·∫∂C THI·∫æU.\n`;
            }
        }

        // Handle recommendation type change
        document.getElementById('testRecommendationType').addEventListener('change', function () {
            const allOptions = ['testItemIdOption', 'testMainDishIdOption', 'testFamilySizeOption', 'testAgeGroupOption'];

            // Hide all options
            allOptions.forEach(id => {
                document.getElementById(id).classList.add('d-none');
            });

            // Show relevant option
            switch (this.value) {
                case 'upsell_combos':
                    document.getElementById('testItemIdOption').classList.remove('d-none');
                    break;
                case 'upsell_sides':
                    document.getElementById('testMainDishIdOption').classList.remove('d-none');
                    break;
                case 'family_combos':
                    document.getElementById('testFamilySizeOption').classList.remove('d-none');
                    break;
                case 'age_based':
                    document.getElementById('testAgeGroupOption').classList.remove('d-none');
                    break;
            }
        });

        // Handle form submission
        document.getElementById('testForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const results = document.getElementById('testResults');
            const userId = document.getElementById('testUserId').value;
            const type = document.getElementById('testRecommendationType').value;

            results.textContent = '';

            function log(message, status = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const className = status === 'error' ? 'status-error' :
                    status === 'success' ? 'status-ok' : 'status-warning';
                results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
                results.scrollTop = results.scrollHeight;
            }

            log('üß™ B·∫Øt ƒë·∫ßu test form submission...', 'info');
            log(`üë§ User ID: ${userId}`, 'info');
            log(`üìù Type: ${type}`, 'info');

            if (!userId || !type) {
                log('‚ùå THI·∫æU TH√îNG TIN: Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß kh√°ch h√†ng v√† lo·∫°i g·ª£i √Ω', 'error');
                return;
            }

            // Test if handleFormSubmission function exists and can be called
            try {
                if (typeof handleFormSubmission === 'function') {
                    log('‚úÖ H√†m handleFormSubmission t√¨m th·∫•y', 'success');

                    // Try to call the function
                    log('üöÄ ƒêang g·ªçi h√†m handleFormSubmission...', 'info');
                    handleFormSubmission(userId, type);
                    log('‚úÖ H√†m handleFormSubmission ƒë∆∞·ª£c g·ªçi th√†nh c√¥ng!', 'success');

                } else {
                    log('‚ùå KH√îNG T√åM TH·∫§Y h√†m handleFormSubmission', 'error');
                }
            } catch (e) {
                log(`üî• L·ªñI khi g·ªçi handleFormSubmission: ${e.message}`, 'error');
            }
        });

        // Test API directly
        async function testAPI(type) {
            const results = document.getElementById('apiResults');
            results.textContent = '';

            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                results.textContent += `[${timestamp}] ${message}\n`;
                results.scrollTop = results.scrollHeight;
            }

            log(`üîç Testing API: ${type}`);

            try {
                let apiUrl = '/api/';
                let params = new URLSearchParams();
                params.append('user_id', '1');

                switch (type) {
                    case 'upsell_combos':
                        apiUrl += 'upsell_combos';
                        params.append('item_id', '54');
                        break;
                    case 'upsell_sides':
                        apiUrl += 'upsell_sides';
                        params.append('main_dish_id', '54');
                        break;
                    case 'family_combos':
                        apiUrl += 'family_combos';
                        params.append('family_size', '4');
                        break;
                    case 'age_based':
                        apiUrl += 'age_based_recommendations';
                        params.append('age_group', 'adults');
                        break;
                }

                const fullUrl = `${apiUrl}?${params.toString()}`;
                log(`üì° G·ª≠i request: ${fullUrl}`);

                const startTime = Date.now();
                const response = await fetch(fullUrl);
                const endTime = Date.now();

                log(`‚è±Ô∏è Th·ªùi gian ph·∫£n h·ªìi: ${endTime - startTime}ms`);
                log(`üìä Status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ TH√ÄNH C√îNG! Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ API`);

                    if (data.recommendations && data.recommendations.length > 0) {
                        log(`üçΩÔ∏è T√¨m th·∫•y ${data.recommendations.length} g·ª£i √Ω m√≥n ƒÉn`);
                        log(`üìù M√≥n ƒë·∫ßu ti√™n: ${data.recommendations[0].recipe_name}`);
                    } else if (data.combo_recommendations && data.combo_recommendations.length > 0) {
                        log(`üç± T√¨m th·∫•y ${data.combo_recommendations.length} combo g·ª£i √Ω`);
                        log(`üìù Combo ƒë·∫ßu ti√™n: ${data.combo_recommendations[0].recipe_name}`);
                    } else {
                        log(`‚ö†Ô∏è API ph·∫£n h·ªìi nh∆∞ng kh√¥ng c√≥ g·ª£i √Ω n√†o`);
                    }

                    log(`üìã D·ªØ li·ªáu: ${JSON.stringify(data, null, 2).substring(0, 200)}...`);
                } else {
                    log(`‚ùå API L·ªñI: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                log(`üî• L·ªñI: ${error.message}`);
            }
        }

        // Auto-run function check on page load
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                checkAllFunctions();
            }, 1000);
        });
    </script>
</body>

</html>
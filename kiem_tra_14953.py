#!/usr/bin/env python3
"""
Kiá»ƒm tra Ä‘áº§y Ä‘á»§ xem há»‡ thá»‘ng Ä‘Ã£ load 14,953 interactions chÆ°a
"""

import sqlite3
import os
import requests
import json
from datetime import datetime


def kiem_tra_database():
    """Kiá»ƒm tra database SQLite"""
    print("ğŸ” KIá»‚M TRA DATABASE SQLite")
    print("=" * 40)

    db_path = './simple_food_db.sqlite'
    if not os.path.exists(db_path):
        print("âŒ KhÃ´ng tÃ¬m tháº¥y file database!")
        return False

    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Äáº¿m sá»‘ lÆ°á»£ng records
    cursor.execute('SELECT COUNT(*) FROM recipes')
    recipes_count = cursor.fetchone()[0]

    cursor.execute('SELECT COUNT(*) FROM customers')
    customers_count = cursor.fetchone()[0]

    cursor.execute('SELECT COUNT(*) FROM interactions')
    interactions_count = cursor.fetchone()[0]

    print(f"ğŸ“Š Sá» LIá»†U HIá»†N Táº I:")
    print(f"   ğŸ½ï¸  Recipes (cÃ´ng thá»©c): {recipes_count:,}")
    print(f"   ğŸ‘¥ Customers (khÃ¡ch hÃ ng): {customers_count:,}")
    print(f"   ğŸ’¬ Interactions (tÆ°Æ¡ng tÃ¡c): {interactions_count:,}")

    # Kiá»ƒm tra má»¥c tiÃªu 14,953
    target = 14953
    if interactions_count == target:
        print(
            f"\nğŸ‰ THÃ€NH CÃ”NG! ÄÃ£ load Ä‘á»§ {interactions_count:,} interactions!")
        status = "âœ… HOÃ€N THÃ€NH"
    elif interactions_count > 0:
        missing = target - interactions_count
        print(f"\nâš ï¸  THIáº¾U: {missing:,} interactions")
        print(f"   Hiá»‡n cÃ³: {interactions_count:,}/{target:,}")
        status = "ğŸ”„ CHÆ¯A Äá»¦"
    else:
        print(f"\nâŒ CHÆ¯A LOAD: KhÃ´ng cÃ³ interactions nÃ o!")
        status = "âŒ CHÆ¯A LOAD"

    # Kiá»ƒm tra cháº¥t lÆ°á»£ng dá»¯ liá»‡u
    if interactions_count > 0:
        print(f"\nğŸ“ˆ CHáº¤T LÆ¯á»¢NG Dá»® LIá»†U:")

        # Unique customers vÃ  recipes
        cursor.execute('SELECT COUNT(DISTINCT customer_id) FROM interactions')
        unique_customers = cursor.fetchone()[0]

        cursor.execute('SELECT COUNT(DISTINCT recipe_name) FROM interactions')
        unique_recipes = cursor.fetchone()[0]

        print(f"   - KhÃ¡ch hÃ ng unique: {unique_customers:,}")
        print(f"   - CÃ´ng thá»©c unique: {unique_recipes:,}")

        # Rating distribution
        cursor.execute(
            'SELECT AVG(rating), MIN(rating), MAX(rating) FROM interactions WHERE rating > 0')
        avg_rating, min_rating, max_rating = cursor.fetchone()
        if avg_rating:
            print(
                f"   - ÄÃ¡nh giÃ¡ TB: {avg_rating:.2f} (tá»« {min_rating} Ä‘áº¿n {max_rating})")

        # Máº«u dá»¯ liá»‡u gáº§n Ä‘Ã¢y
        print(f"\nğŸ“‹ MáºªU Dá»® LIá»†U Gáº¦N ÄÃ‚Y:")
        cursor.execute('''
            SELECT customer_id, recipe_name, rating, interaction_date 
            FROM interactions 
            ORDER BY interaction_date DESC 
            LIMIT 3
        ''')
        samples = cursor.fetchall()
        for i, (customer_id, recipe_name, rating, date) in enumerate(samples, 1):
            print(f"   {i}. {customer_id}: {recipe_name} (â­{rating}, {date})")

    conn.close()
    return interactions_count == target, status


def kiem_tra_flask_app():
    """Kiá»ƒm tra Flask application"""
    print(f"\nğŸŒ KIá»‚M TRA FLASK APPLICATION")
    print("=" * 40)

    try:
        # Test API stats
        response = requests.get(
            'http://localhost:5000/api/agent_stats', timeout=5)
        if response.status_code == 200:
            stats = response.json()
            print("âœ… Flask App Ä‘ang cháº¡y!")
            print("ğŸ“Š API Stats:")
            print(f"   - Recipes: {stats.get('recipes_count', 'N/A')}")
            print(f"   - Customers: {stats.get('customers_count', 'N/A')}")
            if 'dataset_info' in stats:
                print(f"   - Dataset: {stats['dataset_info']}")

            # Test AI Agent
            print(f"\nğŸ¤– TEST AI AGENT:")
            test_data = {
                'message': 'Há»‡ thá»‘ng cÃ³ bao nhiÃªu dá»¯ liá»‡u tÆ°Æ¡ng tÃ¡c khÃ¡ch hÃ ng?',
                'customer_id': 'CUS00001'
            }
            chat_response = requests.post('http://localhost:5000/api/agent_chat',
                                          json=test_data,
                                          headers={
                                              'Content-Type': 'application/json'},
                                          timeout=15)
            if chat_response.status_code == 200:
                result = chat_response.json()
                agent_response = result.get('response', '')
                print(f"âœ… AI Agent pháº£n há»“i ({len(agent_response)} kÃ½ tá»±):")
                print(f"   {agent_response[:150]}...")
                return True, "âœ… HOáº T Äá»˜NG"
            else:
                print(f"âŒ AI Agent lá»—i: {chat_response.status_code}")
                return False, "âŒ Lá»–I API"
        else:
            print(f"âŒ Flask App khÃ´ng pháº£n há»“i: {response.status_code}")
            return False, "âŒ KHÃ”NG PHáº¢N Há»’I"
    except Exception as e:
        print(f"âš ï¸  Flask App khÃ´ng cháº¡y: {e}")
        print("ğŸ’¡ Äá»ƒ khá»Ÿi Ä‘á»™ng: python app.py")
        return False, "âš ï¸ KHÃ”NG CHáº Y"


def main():
    print("ğŸš€ KIá»‚M TRA Há»† THá»NG AI FOOD RECOMMENDATION")
    print("=" * 60)
    print(f"ğŸ“… Thá»i gian: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

    # Kiá»ƒm tra database
    db_success, db_status = kiem_tra_database()

    # Kiá»ƒm tra Flask app
    app_success, app_status = kiem_tra_flask_app()

    # Tá»•ng káº¿t
    print(f"\nğŸ“‹ Tá»”NG Káº¾T KIá»‚M TRA")
    print("=" * 30)
    print(f"ğŸ’¾ Database: {db_status}")
    print(f"ğŸŒ Flask App: {app_status}")

    if db_success and app_success:
        print(f"\nğŸ‰ Káº¾T LUáº¬N: Há»† THá»NG HOÃ€N CHá»ˆNH!")
        print("âœ… ÄÃ£ load Ä‘á»§ 14,953 interactions")
        print("âœ… Flask app hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng")
        print("âœ… AI Agent sáºµn sÃ ng phá»¥c vá»¥")
        print("ğŸš€ READY FOR PRODUCTION!")
    elif db_success:
        print(f"\nğŸ”„ Káº¾T LUáº¬N: DATABASE OK, Cáº¦N KHá»I Äá»˜NG APP")
        print("âœ… Dá»¯ liá»‡u Ä‘Ã£ load Ä‘áº§y Ä‘á»§")
        print("âš ï¸  Cáº§n cháº¡y Flask app: python app.py")
    else:
        print(f"\nâš ï¸  Káº¾T LUáº¬N: Cáº¦N HOÃ€N THIá»†N LOAD Dá»® LIá»†U")
        print("ğŸ”„ Cháº¡y script load dá»¯ liá»‡u: python load_all_interactions.py")


if __name__ == "__main__":
    main()

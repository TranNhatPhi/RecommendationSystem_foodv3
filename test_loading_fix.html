<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Loading Fix - Nutrition & Meal Plans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .test-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .log-output {
            background: #2d3748;
            color: #fff;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .status-success {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .status-info {
            color: #17a2b8;
        }

        .btn-test {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .result-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-bug me-3"></i>Test Loading Fix</h1>
            <p class="lead">Ki·ªÉm tra v√† s·ª≠a l·ªói "loading m√£i kh√¥ng c√≥ k·∫øt qu·∫£"</p>
        </div>

        <!-- Test Controls -->
        <div class="result-section">
            <h3><i class="fas fa-play-circle me-2"></i>Test Controls</h3>
            <div class="row">
                <div class="col-md-3">
                    <label for="testUserId" class="form-label">User ID</label>
                    <select class="form-select" id="testUserId">
                        <option value="">-- Ch·ªçn Customer --</option>
                        <option value="1">Customer 1</option>
                        <option value="2">Customer 2</option>
                        <option value="5">Customer 5</option>
                        <option value="10">Customer 10</option>
                        <option value="50" selected>Customer 50</option>
                        <option value="100">Customer 100</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="nutritionType" class="form-label">Nutrition Type</label>
                    <select class="form-select" id="nutritionType">
                        <option value="weight-loss">Weight Loss</option>
                        <option value="balanced">Balanced</option>
                        <option value="blood-boost">Blood Boost</option>
                        <option value="brain-boost">Brain Boost</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-test" onclick="runFullDiagnostic()">
                        <i class="fas fa-diagnoses me-2"></i>Full Diagnostic
                    </button>
                    <button class="btn btn-test" onclick="testOriginalApp()">
                        <i class="fas fa-external-link-alt me-2"></i>Test Original App
                    </button>
                    <button class="btn btn-test" onclick="clearLog()">
                        <i class="fas fa-trash me-2"></i>Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Tests -->
        <div class="result-section">
            <h3><i class="fas fa-rocket me-2"></i>Quick Tests</h3>
            <button class="btn btn-test" onclick="testNutritionAPI()">
                <i class="fas fa-leaf me-2"></i>Test Nutrition API
            </button>
            <button class="btn btn-test" onclick="testMealPlansAPI()">
                <i class="fas fa-utensils me-2"></i>Test Meal Plans API
            </button>
            <button class="btn btn-test" onclick="testJavaScriptSyntax()">
                <i class="fas fa-code me-2"></i>Test JavaScript Syntax
            </button>
            <button class="btn btn-test" onclick="testConsole()">
                <i class="fas fa-terminal me-2"></i>Test Console Functions
            </button>
        </div>

        <!-- Diagnostic Results -->
        <div class="result-section">
            <h3><i class="fas fa-chart-line me-2"></i>Diagnostic Results</h3>
            <div id="diagnosticResults">
                <div class="highlight">
                    <strong>üéØ Fixed Issues:</strong>
                    <ul>
                        <li>‚úÖ JavaScript syntax error trong script.js (d√≤ng 1912) - FIXED</li>
                        <li>‚úÖ C·∫•u tr√∫c function loadNutritionRecommendations() - FIXED</li>
                        <li>‚úÖ Missing closing brackets - FIXED</li>
                    </ul>
                </div>
                <div id="testStatus">Ch·ªù diagnostic...</div>
            </div>
        </div>

        <!-- API Test Results -->
        <div class="row">
            <div class="col-md-6">
                <div class="result-section">
                    <h4><i class="fas fa-leaf text-success me-2"></i>Nutrition API</h4>
                    <div id="nutritionResults" class="result-container">
                        Waiting for test...
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="result-section">
                    <h4><i class="fas fa-utensils text-info me-2"></i>Meal Plans API</h4>
                    <div id="mealPlansResults" class="result-container">
                        Waiting for test...
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Log -->
        <div class="result-section">
            <h3><i class="fas fa-terminal me-2"></i>Console Log</h3>
            <div id="logOutput" class="log-output">
                Test started...\n
            </div>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('logOutput');
        const nutritionResults = document.getElementById('nutritionResults');
        const mealPlansResults = document.getElementById('mealPlansResults');
        const testStatus = document.getElementById('testStatus');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#4CAF50',
                error: '#F44336',
                info: '#2196F3',
                warning: '#FF9800'
            };
            const color = colors[type] || colors.info;
            logOutput.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            logOutput.innerHTML = 'Log cleared...\n';
            nutritionResults.innerHTML = 'Cleared...';
            mealPlansResults.innerHTML = 'Cleared...';
            testStatus.innerHTML = 'Ready for new test...';
        }

        async function testNutritionAPI() {
            const userId = document.getElementById('testUserId').value;
            const nutritionType = document.getElementById('nutritionType').value;

            if (!userId) {
                log('‚ùå Please select a User ID first', 'error');
                return;
            }

            log(`ü•ó Testing Nutrition API - User: ${userId}, Type: ${nutritionType}`, 'info');
            nutritionResults.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const apiUrl = `/api/nutrition_recommendations?user_id=${userId}&nutrition_type=${nutritionType}&count=6`;
                log(`üì° API URL: ${apiUrl}`, 'info');

                const response = await fetch(apiUrl);
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`‚úÖ Nutrition data received: ${data.recommendations?.length || 0} items`, 'success');

                if (data.recommendations && data.recommendations.length > 0) {
                    nutritionResults.innerHTML = data.recommendations.map(rec => `
                        <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong>${rec.recipe_name}</strong><br>
                            <small>Rating: ${rec.predicted_rating?.toFixed(1) || 'N/A'}</small><br>
                            <small>Difficulty: ${rec.difficulty || 'N/A'}</small>
                        </div>
                    `).join('');
                } else {
                    nutritionResults.innerHTML = '<div class="text-muted">No recommendations found</div>';
                }

            } catch (error) {
                log(`‚ùå Nutrition API Error: ${error.message}`, 'error');
                nutritionResults.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
            }
        }

        async function testMealPlansAPI() {
            const userId = document.getElementById('testUserId').value;

            if (!userId) {
                log('‚ùå Please select a User ID first', 'error');
                return;
            }

            log(`üçΩÔ∏è Testing Meal Plans API - User: ${userId}`, 'info');
            mealPlansResults.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const apiUrl = `/api/meal_plans?user_id=${userId}&days=3`;
                log(`üì° API URL: ${apiUrl}`, 'info');

                const response = await fetch(apiUrl);
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`‚úÖ Meal plans data received: ${data.meal_plans?.length || 0} plans`, 'success');

                if (data.meal_plans && data.meal_plans.length > 0) {
                    mealPlansResults.innerHTML = data.meal_plans.map((plan, index) => `
                        <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 0.5rem; margin-bottom: 0.5rem;">
                            <strong>Plan ${index + 1}</strong><br>
                            ${plan.breakfast ? `<small>üåÖ ${plan.breakfast.recipe_name}</small><br>` : ''}
                            ${plan.lunch ? `<small>‚òÄÔ∏è ${plan.lunch.recipe_name}</small><br>` : ''}
                            ${plan.dinner ? `<small>üåô ${plan.dinner.recipe_name}</small><br>` : ''}
                        </div>
                    `).join('');
                } else {
                    mealPlansResults.innerHTML = '<div class="text-muted">No meal plans found</div>';
                }

            } catch (error) {
                log(`‚ùå Meal Plans API Error: ${error.message}`, 'error');
                mealPlansResults.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
            }
        }

        function testJavaScriptSyntax() {
            log('üîç Testing JavaScript syntax...', 'info');

            try {
                // Test if main functions exist in the global scope
                const functionsToTest = [
                    'loadNutritionRecommendations',
                    'loadMealPlans',
                    'reloadNutritionAndMealPlans',
                    'displayNutritionRecommendations',
                    'displayMealPlans'
                ];

                log('üß™ Testing main page functions...', 'info');

                if (window.opener && !window.opener.closed) {
                    functionsToTest.forEach(funcName => {
                        const exists = typeof window.opener[funcName] === 'function';
                        log(`${exists ? '‚úÖ' : '‚ùå'} Function ${funcName}: ${exists ? 'EXISTS' : 'NOT FOUND'}`, exists ? 'success' : 'error');
                    });
                } else {
                    log('‚ÑπÔ∏è Cannot access main page - open this from main page', 'warning');
                }

                log('‚úÖ JavaScript syntax test completed', 'success');

            } catch (error) {
                log(`‚ùå JavaScript syntax error: ${error.message}`, 'error');
            }
        }

        function testConsole() {
            log('üñ•Ô∏è Testing console functions...', 'info');

            try {
                // Test console functions if main page is available
                if (window.opener && !window.opener.closed) {
                    // Test debug functions
                    if (typeof window.opener.debugCustomerSelection === 'function') {
                        log('‚úÖ debugCustomerSelection function available', 'success');
                    }
                    if (typeof window.opener.forceReloadNutritionAndMealPlans === 'function') {
                        log('‚úÖ forceReloadNutritionAndMealPlans function available', 'success');
                    }
                    if (typeof window.opener.testAPICalls === 'function') {
                        log('‚úÖ testAPICalls function available', 'success');
                    }
                } else {
                    log('‚ÑπÔ∏è Open this page from main app to test console functions', 'warning');
                }

                log('‚úÖ Console function test completed', 'success');

            } catch (error) {
                log(`‚ùå Console test error: ${error.message}`, 'error');
            }
        }

        async function runFullDiagnostic() {
            log('üéØ Running full diagnostic...', 'info');
            testStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running diagnostic...';

            await testJavaScriptSyntax();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testNutritionAPI();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testMealPlansAPI();
            await new Promise(resolve => setTimeout(resolve, 500));

            testConsole();

            testStatus.innerHTML = '<span class="status-success">‚úÖ Full diagnostic completed!</span>';
            log('üéâ Full diagnostic completed successfully!', 'success');
        }

        function testOriginalApp() {
            log('üåê Opening original app for testing...', 'info');
            const mainAppWindow = window.open('/', '_blank');

            setTimeout(() => {
                if (mainAppWindow && !mainAppWindow.closed) {
                    log('‚úÖ Original app opened. You can now test the fixed loading issue.', 'success');
                    log('üí° Try selecting a customer and see if nutrition/meal plans load properly.', 'info');
                } else {
                    log('‚ùå Could not open original app', 'error');
                }
            }, 1000);
        }

        // Auto-start diagnostic on page load
        document.addEventListener('DOMContentLoaded', function () {
            log('üöÄ Test page loaded successfully', 'success');
            log('üîß JavaScript syntax errors have been fixed:', 'success');
            log('  - Fixed function structure in loadNutritionRecommendations()', 'success');
            log('  - Fixed missing closing brackets', 'success');
            log('  - Fixed improper setTimeout placement', 'success');
            log('üí° Click "Full Diagnostic" to test all functionality', 'info');
        });
    </script>
</body>

</html>